<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZarzƒÖdzanie listami filtr√≥w</title>
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="icon" href="../img/logo.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <!-- Sidebar navigation -->
    <div class="sidebar">
        <div class="logo">
            <img src="../img/logo.png" alt="Logo Prone">
            <p>Prone</p>
        </div>
        <nav>
            <ul>
                <li><a href="/pl/dashboard">Ekran g≈Ç√≥wny</a></li>
                <li><a href="/pl/query_log">Logi zapyta≈Ñ</a></li>
                <li><a href="/pl/groups">Grupy</a></li>
                <li><a href="/pl/adlists" class="active">Lista filtr√≥w</a></li>
                <li><a href="/pl/clients">Klienci</a></li>
                <li><a href="/pl/domains">Domeny</a></li>
                <li><a href="/pl/settings">Ustawienia</a></li>
            </ul>
        </nav>
    </div>

    <!-- Main content -->
    <div class="main-content">
        <h1>ZarzƒÖdzanie listami filtr√≥w</h1>
    
        <!-- Add a new adlist section -->
        <div class="add-adlist">
            <h2>Dodaj nowƒÖ listƒô</h2>
            <div class="adlist-form">
                <label for="adlist-address">Adres:</label>
                <input type="text" id="adlist-address" placeholder="URL lub adresy oddzielone spacjƒÖ">
                <label for="adlist-comment">Komentarz:</label>
                <input type="text" id="adlist-comment" placeholder="Opis listy (opcjonalne)"><br>
            </div>
            <button type="button" id="add-adlist-button" class="add-button">Dodaj</button>
        </div>
    
        <!-- List of adlists -->
        <div class="list-adlists">
            <h2>Lista filtr√≥w</h2>
            <div class="table-controls">
                <label for="show-entries">Wy≈õwietl</label>
                <select id="show-entries">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span>wpis√≥w</span>
                <label for="search-adlists">Szukaj:</label>
                <input type="text" id="search-adlists" placeholder="Szukaj...">
            </div>
            <table class="adlist-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>Adres</th>
                        <th>Status</th>
                        <th>Komentarz</th>
                        <th>Przypisanie do grupy</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody id="adlist-table-body">
                    <!-- Rows will be dynamically populated here -->
                </tbody>
            </table>
            <br>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchAdlists();
    
            const addAdlistButton = document.querySelector('.add-button');
            addAdlistButton.addEventListener('click', async () => {
                const address = document.getElementById('adlist-address').value;
                const comment = document.getElementById('adlist-comment').value;
    
                if (!address.trim()) {
                    alert('Adres jest wymagany!');
                    return;
                }
    
                try {
                    const response = await fetch('/adlists/addAdlist', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ address, comment }),
                    });
    
                    const result = await response.json();
    
                    if (response.ok) {
                        alert('Nowa lista zosta≈Ça dodana.');
                        fetchAdlists(); // Refresh the table
                    } else {
                        alert(result.message || 'Nie uda≈Ço siƒô dodaƒá nowej listy.');
                    }
                } catch (error) {
                    console.error('Error adding adlist:', error);
                    alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania nowej listy.');
                }
            });
        });
    
        async function fetchAdlists() {
            try {
                const response = await fetch('/adlists/getAdlists');
                const groupsResponse = await fetch('/groups/getGroups');
                const data = await response.json();
                const groupsData = await groupsResponse.json();

                if (data.success && groupsData.success && Array.isArray(data.data)) {
                    const adlists = data.data;
                    const groups = groupsData.data;
                    const tableBody = document.getElementById('adlist-table-body');

                    tableBody.innerHTML = '';

                    for (const adlist of adlists) {
                        // Initialize adlistGroupIds
                        const adlistGroupIds = await getAdlistGroups(adlist.address);

                        const row = document.createElement('tr');
                        row.innerHTML += `<td><input type="checkbox"></td>`;
                        row.innerHTML += `<td><a href="${adlist.address}" target="_blank">${adlist.address}</a></td>`;
                        row.innerHTML += 
                            `<td>
                                <label class="switch">
                                    <input type="checkbox" class="adlist-toggle" data-address="${adlist.address}" ${adlist.enabled ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                            </td>`;
                        row.innerHTML += `<td>${adlist.comment || 'Brak komentarza'}</td>`;

                        const dropdownContainer = document.createElement('div');
                        dropdownContainer.classList.add('dropdown-container');
                        dropdownContainer.innerHTML = `
                            <button class="dropdown-button">Grupy</button>
                            <div class="dropdown-content">
                                ${groups.map(group => `
                                    <label>
                                        <input 
                                            type="checkbox" 
                                            class="group-checkbox" 
                                            data-address="${adlist.address}" 
                                            data-group-id="${group.id}" 
                                            ${adlistGroupIds.includes(group.id) ? 'checked' : ''}>
                                        ${group.name}
                                    </label>
                                `).join('')}
                            </div>
                        `;

                        // Attach dropdown to the table row
                        row.innerHTML += `<td>${dropdownContainer.outerHTML}</td>`;
                        row.innerHTML += `
                            <td>
                                <button class="edit-button" data-address="${adlist.address}">üìù</button>
                                <button class="done-button" data-address="${adlist.address}" style="display:none;">‚úîÔ∏è</button>
                                <button class="delete-button" data-address="${adlist.address}">‚ùå</button>
                            </td>
                        `;

                        tableBody.appendChild(row);
                    }

                    document.querySelectorAll('.delete-button').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const address = e.target.getAttribute('data-address');
                            await removeAdlist(address);
                        });
                    });

                    document.querySelectorAll('.edit-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const row = e.target.closest('tr');
                            toggleEditMode(row, true);
                        });
                    });

                    document.querySelectorAll('.done-button').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const row = e.target.closest('tr');
                            const addressCell = row.querySelector('td:nth-child(2)');
                            const commentCell = row.querySelector('td:nth-child(4)');

                            const oldAddress = e.target.dataset.address;
                            const newAddress = addressCell.querySelector('input').value.trim();
                            const newComment = commentCell.querySelector('input').value.trim();

                            try {
                                if (oldAddress !== newAddress) {
                                    await updateAdlistAddress(oldAddress, newAddress);
                                }
                                if (row.dataset.comment !== newComment) {
                                    await updateAdlistComment(newAddress, newComment);
                                }
                                fetchAdlists(); // Refresh table
                            } catch (error) {
                                alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji listy.');
                            }
                        });
                    });

                    document.querySelectorAll('.adlist-toggle').forEach(toggle => {
                        toggle.addEventListener('change', async (e) => {
                            const address = e.target.dataset.address;
                            const enabled = e.target.checked;
                            await toggleAdlistStatus(address, enabled);
                        });
                    });

                    // Fix for issue: ensure that the event listener works even for dynamically generated checkboxes
                    document.getElementById('adlist-table-body').addEventListener('change', async (e) => {
                        if (e.target.classList.contains('group-checkbox')) {
                            const checkbox = e.target;
                            const selectedGroupId = checkbox.dataset.groupId;
                            const address = checkbox.dataset.address;
                            const groupName = checkbox.closest('label').textContent.trim();
                            const isChecked = checkbox.checked;

                            if (isChecked) {
                                await addAdlistToGroup(address, groupName);
                            } else {
                                await removeAdlistFromGroup(address, groupName);
                            }
                        }
                    });

                } else {
                    console.error('Failed to fetch adlists:', data);
                }
            } catch (error) {
                console.error('Error fetching adlists:', error);
            }
        }

        async function removeAdlist(address) {
            if (!confirm(`Czy na pewno chcesz usunƒÖƒá listƒô o adresie ${address}?`)) {
                return;
            }
    
            try {
                const response = await fetch('/adlists/removeAdlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address }),
                });
    
                const result = await response.json();
    
                if (response.ok) {
                    alert('Lista zosta≈Ça usuniƒôta.');
                    fetchAdlists(); // Refresh the table
                } else {
                    alert(result.message || 'Nie uda≈Ço siƒô usunƒÖƒá listy.');
                }
            } catch (error) {
                console.error('Error removing adlist:', error);
                alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania listy.');
            }
        }

        function toggleEditMode(row, isEditing) {
            const addressCell = row.querySelector('td:nth-child(2)');
            const commentCell = row.querySelector('td:nth-child(4)');
            const editButton = row.querySelector('.edit-button');
            const doneButton = row.querySelector('.done-button');

            if (isEditing) {
                // Save original values in dataset
                row.dataset.comment = commentCell.textContent.trim();

                // Replace text with inputs
                const address = addressCell.textContent.trim();
                const comment = commentCell.textContent.trim();

                addressCell.innerHTML = `<input type="text" value="${address}" />`;
                commentCell.innerHTML = `<input type="text" value="${comment}" />`;

                editButton.style.display = 'none';
                doneButton.style.display = 'inline-block';
            } else {
                // Restore text
                const address = addressCell.querySelector('input').value.trim();
                const comment = commentCell.querySelector('input').value.trim();

                addressCell.innerHTML = `<a href="${address}" target="_blank">${address}</a>`;
                commentCell.innerHTML = comment || 'Brak komentarza';

                editButton.style.display = 'inline-block';
                doneButton.style.display = 'none';
            }
        }

        async function updateAdlistAddress(oldAddress, newAddress) {
            try {
                await axios.post('/adlists/editAdlistAddress', { oldAddress, newAddress });
                alert('Adres zosta≈Ç zaktualizowany.');
            } catch (error) {
                console.error('Error updating address:', error);
                throw new Error('Nie uda≈Ço siƒô zaktualizowaƒá adresu.');
            }
        }

        async function updateAdlistComment(address, comment) {
            try {
                await axios.post('/adlists/editAdlistComment', { address, comment });
                alert('Komentarz zosta≈Ç zaktualizowany.');
            } catch (error) {
                console.error('Error updating comment:', error);
                throw new Error('Nie uda≈Ço siƒô zaktualizowaƒá komentarza.');
            }
        }

        async function toggleAdlistStatus(address, enabled) {
            const endpoint = enabled ? '/adlists/enableAdlist' : '/adlists/disableAdlist';

            try {
                const response = await axios.post(endpoint, { address });

                if (response.status === 200) {
                    alert(`Lista zosta≈Ça ${enabled ? 'w≈ÇƒÖczona' : 'wy≈ÇƒÖczona'}.`);
                } else {
                    throw new Error(response.data?.message || 'B≈ÇƒÖd podczas aktualizacji statusu.');
                }
            } catch (error) {
                console.error(`Error toggling adlist status for ${address}:`, error);
                alert(`Nie uda≈Ço siƒô ${enabled ? 'w≈ÇƒÖczyƒá' : 'wy≈ÇƒÖczyƒá'} listy.`);
            }
        }

        async function getAdlistGroups(address) {
            try {
                const response = await fetch('/adlists/getAdlistGroups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address }),
                });
                const result = await response.json();
                if (result.success) {
                    return result.data.map(group => group.group_id);
                }
                return [];
            } catch (error) {
                console.error('Error fetching adlist groups:', error);
                return [];
            }
        }

        async function addAdlistToGroup(address, group) {
            try {
                await axios.post('/adlists/addAdlistToGroup', { address, group });
                alert('Adlist added to group successfully');
            } catch (error) {
                console.error('Error adding adlist to group:', error);
                alert('Failed to add adlist to group');
            }
        }

        async function removeAdlistFromGroup(address, group) {
            try {
                await axios.post('/adlists/removeAdlistFromGroup', { address, group });
                alert('Adlist removed from group successfully');
            } catch (error) {
                console.error('Error removing adlist from group:', error);
                alert('Failed to remove adlist from group');
            }
        }
    </script>        
</html>