<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZarzƒÖdzanie Domenami</title>
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="icon" href="../img/logo.png" type="image/png">
</head>
<body>
    <!-- Sidebar navigation -->
    <div class="sidebar">
        <div class="logo">
            <img src="../img/logo.png" alt="Prone Logo">
            <p>Prone</p>
        </div>
        <nav>
            <ul>
                <li><a href="/pl/dashboard">Ekran g≈Ç√≥wny</a></li>
                <li><a href="/pl/query_log">Logi zapyta≈Ñ</a></li>
                <li><a href="/pl/groups">Grupy</a></li>
                <li><a href="/pl/adlists">Lista filtr√≥w</a></li>
                <li><a href="/pl/clients">Klienci</a></li>
                <li><a href="/pl/domains">Domeny</a></li>
                <li><a href="/pl/settings">Ustawienia</a></li>
            </ul>
        </nav>
    </div>

    <!-- Main content -->
    <div class="container">
        <h1>ZarzƒÖdzanie domenami</h1>

        <section class="add-domain">
            <h2>Dodaj nowƒÖ domenƒô</h2>
            <label for="domain">Domena:</label>
            <input type="text" id="domain" placeholder="Wprowad≈∫ domenƒô">
            
            <label for="comment">Komentarz:</label>
            <input type="text" id="comment" placeholder="Wprowad≈∫ komentarz">
            
            <label for="status">Status:</label>
            <select id="status">
                <option value="allowed">Dozwolone</option>
                <option value="blocked">Zablokowane</option>
            </select>

            <div class="tips">
                <p><strong>Wskaz√≥wki:</strong></p>
                <ul>
                    <li>Mo≈ºna dodaƒá wiele domen, oddzielajƒÖc ka≈ºdƒÖ nazwƒô domeny spacjƒÖ.</li>
                    <li>Nazwy domen mogƒÖ zawieraƒá spacje, je≈õli sƒÖ wprowadzone w cudzys≈Çowiu. Na przyk≈Çad "example.com".</li>
                </ul>
            </div>
            <button class="btn">Dodaj</button>
        </section>

        <section class="domain-list">
            <h2>Domeny Dozwolone</h2>
            <table>
                <thead>
                    <tr>
                        <th>Domena</th>
                        <th>Komentarz</th>
                        <th>Status</th>
                        <th>Grupy</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody class="whitelist-table">
                    <tr>
                        <td colspan="4">≈Åadowanie domen...</td>
                    </tr>
                    
                </tbody>
            </table>
        </section>

        <section class="domain-list">
            <h2>Domeny Zablokowane</h2>
            <table>
                <thead>
                    <tr>
                        <th>Domena</th>
                        <th>Komentarz</th>
                        <th>Status</th>
                        <th>Grupy</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody class="blacklist-table">
                    <tr>
                        <td colspan="4">≈Åadowanie domen...</td>
                    </tr>
                </tbody>
            </table>
        </section>
    </div>

    <footer>
        Created by ACDIT Sp. z o.o.
    </footer>

</body>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
    const whitelistTable = document.querySelector('.whitelist-table');
    const blacklistTable = document.querySelector('.blacklist-table');
    const addButton = document.querySelector('.btn');
    const domainInput = document.querySelector('#domain');
    const commentInput = document.querySelector('#comment');
    const statusSelect = document.querySelector('#status');

    const fetchDomains = async (url) => {
        try {
            const response = await fetch(url, { method: 'GET' });
            if (!response.ok) throw new Error('Failed to fetch data');
            const data = await response.json();
            return data.data || [];
        } catch (error) {
            console.error('Error fetching domains:', error);
            return [];
        }
    };

    const populateTable = async (table, domains, actionType) => {
        const groups = await fetchGroups();

        table.innerHTML = ''; // Clear existing rows
        domains.forEach(domain => {
            const row = document.createElement('tr');

            // Domain column
            const domainCell = document.createElement('td');
            domainCell.textContent = domain.domain;
            domainCell.classList.add('domain-text');
            row.appendChild(domainCell);

            // Comment column
            const commentCell = document.createElement('td');
            commentCell.textContent = domain.comment || 'Brak komentarza';
            commentCell.classList.add('comment-text');
            row.appendChild(commentCell);

            // ** Switch column **
            const switchCell = document.createElement('td');
            const switchContainer = document.createElement('label');
            switchContainer.classList.add('switch');

            const switchInput = document.createElement('input');
            switchInput.type = 'checkbox';
            switchInput.checked = domain.enabled === 1; // Check the `enabled` property (0 or 1)
            switchInput.addEventListener('change', async () => {
                try {
                    const url = switchInput.checked
                        ? '/domains/enableDomain'
                        : '/domains/disableDomain';
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ domain: domain.domain })
                    });
                    if (!response.ok) throw new Error('Failed to update domain state');
                    console.log(
                        `Domain ${domain.domain} ${switchInput.checked ? 'enabled' : 'disabled'}`
                    );
                } catch (error) {
                    console.error('Error updating domain state:', error);
                    alert('Nie uda≈Ço siƒô zaktualizowaƒá stanu domeny.');
                    switchInput.checked = !switchInput.checked; // Revert state if error
                }
            });

            const slider = document.createElement('span');
            slider.classList.add('slider');

            switchContainer.appendChild(switchInput);
            switchContainer.appendChild(slider);
            switchCell.appendChild(switchContainer);
            row.appendChild(switchCell);

            // Groups column
            const groupCell = document.createElement('td');
            const groupDropdown = createGroupDropdown(domain, groups, domain.groups || []);
            groupCell.appendChild(groupDropdown);
            row.appendChild(groupCell);

            // Actions column
            const actionsCell = document.createElement('td');
            // (Existing Edit/Delete Buttons)
            const editButton = document.createElement('button');
            editButton.textContent = 'üìù';
            editButton.classList.add('edit-button');
            editButton.addEventListener('click', () => toggleEdit(row, domain));
            actionsCell.appendChild(editButton);

            const deleteButton = document.createElement('button');
            deleteButton.textContent = '‚ùå';
            deleteButton.classList.add('delete-button');
            deleteButton.addEventListener('click', () => deleteDomain(row, domain, actionType));
            actionsCell.appendChild(deleteButton);

            row.appendChild(actionsCell);
            table.appendChild(row);
        });
    };


    const toggleEdit = (row, domain) => {
        const domainCell = row.querySelector('.domain-text');
        const commentCell = row.querySelector('.comment-text');
        const actionsCell = row.querySelector('td:last-child');

        if (row.classList.contains('editing')) {
            // Save mode
            const newDomain = domainCell.querySelector('input').value;
            const newComment = commentCell.querySelector('input').value;

            if (newDomain !== domain.domain || newComment !== domain.comment) {
                updateDomain(domain.domain, newDomain, newComment);
            }

            domainCell.textContent = newDomain;
            commentCell.textContent = newComment;

            actionsCell.querySelector('.edit').textContent = '‚úèÔ∏è Edytuj';
            row.classList.remove('editing');
        } else {
            // Edit mode
            const domainInput = document.createElement('input');
            domainInput.type = 'text';
            domainInput.value = domain.domain;

            const commentInput = document.createElement('input');
            commentInput.type = 'text';
            commentInput.value = domain.comment || '';

            domainCell.textContent = '';
            domainCell.appendChild(domainInput);

            commentCell.textContent = '';
            commentCell.appendChild(commentInput);

            actionsCell.querySelector('.edit').textContent = '‚úîÔ∏è Zapisz';
            row.classList.add('editing');
        }
    };

    const fetchGroups = async () => {
        try {
            const response = await fetch('/groups/getGroups', { method: 'GET' });
            if (!response.ok) throw new Error('Failed to fetch groups');
            return (await response.json()).data || [];
        } catch (error) {
            console.error('Error fetching groups:', error);
            return [];
        }
    };

    const createGroupDropdown = (domain, groups, domainGroups) => {
        const dropdownContainer = document.createElement('div');
        dropdownContainer.classList.add('dropdown-container');

        const dropdownButton = document.createElement('button');
        dropdownButton.textContent = 'Wybierz grupy';
        dropdownButton.classList.add('dropdown-button');
        dropdownContainer.appendChild(dropdownButton);

        const dropdownContent = document.createElement('div');
        dropdownContent.classList.add('dropdown-content');
        dropdownContainer.appendChild(dropdownContent);

        groups.forEach(group => {
            const label = document.createElement('label');
            label.textContent = group.name;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = group.id;
            checkbox.checked = domainGroups.includes(group.id);

            // Add event listener for dynamic add/remove
            checkbox.addEventListener('change', async () => {
                try {
                    if (checkbox.checked) {
                        await fetch('/domains/addDomainToGroup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ domain: domain.domain, group: group.name })
                        });
                    } else {
                        await fetch('/domains/removeDomainFromGroup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ domain: domain.domain, group: group.name })
                        });
                    }
                    console.log(`Group ${group.name} ${checkbox.checked ? 'added to' : 'removed from'} domain ${domain.domain}`);
                } catch (error) {
                    console.error('Error updating group:', error);
                    alert('Nie uda≈Ço siƒô zaktualizowaƒá grupy.');
                }
            });

            label.appendChild(checkbox);
            dropdownContent.appendChild(label);
        });

        return dropdownContainer;
    };

    const updateDomain = async (oldDomain, newDomain, newComment) => {
        try {
            if (oldDomain !== newDomain) {
                await fetch('/domains/editDomainName', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ oldDomain, newDomain })
                });
                console.log(`Domain updated: ${oldDomain} -> ${newDomain}`);
            }

            if (newComment !== '') {
                await fetch('/domains/editDomainComment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ domain: newDomain, comment: newComment })
                });
                console.log(`Comment updated for ${newDomain}: ${newComment}`);
            }
        } catch (error) {
            console.error('Error updating domain:', error);
        }
    };

    const addDomain = async (domain, comment, status) => {
        try {
            const url = status === 'allowed' 
                ? '/domains/addToWhitelist' 
                : '/domains/addToBlacklist';
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domain, comment })
            });
            if (!response.ok) throw new Error('Failed to add domain');
            console.log(`Domain ${domain} added successfully to ${status}`);
            return await response.json();
        } catch (error) {
            console.error('Error adding domain:', error);
            alert('Nie uda≈Ço siƒô dodaƒá domeny.');
        }
    };

    addButton.addEventListener('click', async () => {
        const domain = domainInput.value.trim();
        const comment = commentInput.value.trim();
        const status = statusSelect.value;

        if (!domain) {
            alert('Proszƒô podaƒá nazwƒô domeny.');
            return;
        }

        await addDomain(domain, comment, status);

        // Refresh the appropriate table
        const updatedDomains = await fetchDomains(
            status === 'allowed' 
                ? '/domains/getWhitelist' 
                : '/domains/getBlacklist'
        );
        populateTable(
            status === 'allowed' ? whitelistTable : blacklistTable,
            updatedDomains
        );

        // Clear inputs
        domainInput.value = '';
        commentInput.value = '';
    });

    const deleteDomain = async (row, domain) => {
        try {
            // Determine the table class (whitelist or blacklist)
            const tableBody = row.closest('tbody');
            const actionType = tableBody.classList.contains('whitelist-table') ? 'allowed' : 'blocked';

            // Determine the appropriate URL for deletion
            const url = actionType === 'allowed'
                ? '/domains/removeFromWhitelist'
                : '/domains/removeFromBlacklist';

            // Make the DELETE request
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domain: domain.domain })
            });

            if (!response.ok) throw new Error(`Failed to delete domain from ${actionType}`);

            console.log(`Domain ${domain.domain} deleted from ${actionType}`);

            // Remove the row from the table
            row.remove();

            // Fetch the updated domain list and repopulate the table
            const updatedDomains = await fetchDomains(
                actionType === 'allowed' ? '/domains/getWhitelist' : '/domains/getBlacklist'
            );
            populateTable(
                tableBody, // Use the current table body for repopulation
                updatedDomains,
                actionType
            );
        } catch (error) {
            console.error('Error deleting domain:', error);
            alert('Nie uda≈Ço siƒô usunƒÖƒá domeny.');
        }
    };


    // Fetch and populate whitelist
    const whitelist = await fetchDomains('/domains/getWhitelist');
    populateTable(whitelistTable, whitelist, 'block');

    // Fetch and populate blacklist
    const blacklist = await fetchDomains('/domains/getBlacklist');
    populateTable(blacklistTable, blacklist, 'allow');
});
</script>
</html>
