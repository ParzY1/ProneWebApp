<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZarzƒÖdzanie klientami</title>
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="icon" href="../img/logo.png" type="image/png">
</head>
<body>

    <!-- Sidebar navigation -->
    <div class="sidebar">
        <div class="logo">
            <img src="../img/logo.png" alt="Prone Logo">
            <p>Prone</p>
        </div>
        <nav>
            <ul>
                <li><a href="/pl/dashboard">Ekran g≈Ç√≥wny</a></li>
                <li><a href="/pl/query_log">Logi zapyta≈Ñ</a></li>
                <li><a href="/pl/groups">Grupy</a></li>
                <li><a href="/pl/adlists">Lista filtr√≥w</a></li>
                <li><a href="/pl/clients">Klienci</a></li>
                <li><a href="/pl/domains">Domeny</a></li>
                <li><a href="/pl/settings">Ustawienia</a></li>
            </ul>
        </nav>
    </div>

    <!-- Main content -->
    <div class="main-content">
        <h1>ZarzƒÖdzanie klientami</h1>

        <!-- Add new client section -->
        <div class="add-client-section">
            <h2>Dodaj nowego klienta</h2>
            <div class="input-group">
                <label for="client-name">Klienci:</label>
                <input type="text" id="client-name" placeholder="Wpisz nazwƒô klienta">

                <label for="comment">Komentarz:</label>
                <input type="text" id="comment" placeholder="Wpisz komentarz">
            </div>
            <p>Mo≈ºesz wybraƒá istniejƒÖcego klienta lub dodaƒá nowego, wpisujƒÖc powy≈ºej i potwierdzajƒÖc enterem.
            </p>
            <p>
                Klienci mogƒÖ byƒá opisani poprzez adresy IP (IPv4 i IPv6 sƒÖ obs≈Çugiwane), podsieci IP (notacja CIDR, np. 192.168.2.0/24), adresy MAC (np. 12:34:56:78:9A:BC), 
                nazwy host√≥w (np. localhost) lub interfejsy, do kt√≥rych sƒÖ pod≈ÇƒÖczone (poprzedzone dwukropkiem, np. :eth0).

            </p>
            <button class="add-button">Dodaj</button>
        </div>

        <!-- Clients list section -->
        <div class="clients-list-section">
            <h2>Lista skonfigurowanych klient√≥w</h2>
            <div class="filter-options">
                <label for="records"></label>
                <select id="records">
                    <option value="10" selected>10 wpis√≥w</option>
                    <option value="25">25 wpis√≥w</option>
                    <option value="50">50 wpis√≥w</option>
                </select>
        
            </div>

            <table class="clients-table">
                <thead>
                    <tr>
                        <th>IP</th>
                        <th>Komentarz</th>
                        <th>Grupy</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        Created by ACDIT Sp. z o.o.
    </footer>

</body>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
    await fetchClients();

    // Handle the add button click
    document.querySelector('.add-button').addEventListener('click', async () => {
        const ip = document.querySelector('#client-name').value.trim();
        const comment = document.querySelector('#comment').value.trim();

        if (!ip) {
            alert('Proszƒô wprowadziƒá IP klienta.');
            return;
        }

        try {
            const result = await addClient(ip, comment);

            if (result.success) {
                alert('Klient dodany pomy≈õlnie.');
                document.querySelector('#client-name').value = '';
                document.querySelector('#comment').value = '';

                // Add the new client to the table
                const tableBody = document.querySelector('.clients-table tbody');
                const row = document.createElement('tr');
                const now = new Date();
                row.innerHTML = `
                    <td>${ip}</td>
                    <td>${comment || 'Brak'}</td>
                    <td>Default</td>
                    <td>
                        <button class="edit-button">üìù</button>
                        <button class="delete-button">‚ùå</button>
                    </td>`;
                tableBody.appendChild(row);
            } else {
                alert('Nie uda≈Ço siƒô dodaƒá klienta.');
            }
            } catch (error) {
                console.error(error);
                alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania klienta.');
            }
        });
    });

    document.querySelector('.clients-table').addEventListener('click', async (event) => {
        if (event.target.classList.contains('delete-button')) {
            const row = event.target.closest('tr');
            const clientIp = row.cells[0].textContent.trim(); // Get the IP from the first cell
                
            if (confirm(`Czy na pewno chcesz usunƒÖƒá klienta ${clientIp}?`)) {
                try {
                    await removeClient(clientIp);
                    row.remove();
                    alert('Klient zosta≈Ç usuniƒôty.');
                } catch (error) {
                    alert('Nie uda≈Ço siƒô usunƒÖƒá klienta.');
                    console.error('Error removing client:', error);
                }
            }
        }
    });

    async function fetchClients() {
        try {
            const response = await fetch('/clients/getClients');
            if (!response.ok) throw new Error('Failed to fetch clients');

            const { success, data } = await response.json();
            if (!success) throw new Error('Unexpected API response format');

            const groupsResponse = await fetch('/groups/getGroups');
            const groupsData = await groupsResponse.json();
            const allGroups = groupsData.data.map(group => group.name);

            const tableBody = document.querySelector('.clients-table tbody');
            tableBody.innerHTML = '';

            data.forEach(client => {
                const row = document.createElement('tr');
                const assignedGroups = client.groups.split(',').map(group => group.trim());

                row.innerHTML = `
                    <td>${client.ip}</td>
                    <td>${client.comment || 'Brak'}</td>
                    <td>
                        <div class="group-dropdown">
                            <button class="dropdown-btn">Grupy</button>
                            <div class="dropdown-content">
                                ${allGroups.map(group => `
                                    <label>
                                        <input type="checkbox" 
                                            data-group="${group}" 
                                            ${assignedGroups.includes(group) ? 'checked' : ''}>
                                        ${group}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </td>
                    <td>
                        <button class="edit-button">üìù</button>
                        <button class="delete-button">‚ùå</button>
                    </td>`;
                tableBody.appendChild(row);

                row.querySelector('.edit-button').addEventListener('click', () => toggleEditMode(row));

                // Add event listeners for checkboxes
                const checkboxes = row.querySelectorAll('.group-dropdown input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', async (event) => {
                        const groupName = event.target.dataset.group;
                        const clientIp = client.ip;

                        console.log('Client IP:', clientIp);
                        console.log('Group Name:', groupName);

                        if (event.target.checked) {
                            await addClientToGroup(clientIp, groupName);
                        } else {
                            await removeClientFromGroup(clientIp, groupName);
                        }
                    });
                });
            });
        } catch (error) {
            console.error('Error loading clients:', error.message);
            alert('Nie uda≈Ço siƒô za≈Çadowaƒá listy klient√≥w.');
        }
    }

    // Toggle edit mode when edit button is clicked
    function toggleEditMode(row) {
        const ipCell = row.cells[0]; // First cell is the IP column
        const commentCell = row.cells[1]; // Second cell is the Comment column
        const actionCell = row.cells[3]; // Fourth cell is the Actions column

        const originalIp = ipCell.textContent.trim();
        const originalComment = commentCell.textContent.trim();

        ipCell.innerHTML = `<input type="text" class="edit-ip" value="${originalIp}">`;
        commentCell.innerHTML = `<input type="text" class="edit-comment" value="${originalComment}">`;

        actionCell.innerHTML = `
            <button class="done-button">Zako≈Ñcz</button>
        `;

        actionCell.querySelector('.done-button').addEventListener('click', async () => {
            const newIp = ipCell.querySelector('.edit-ip').value.trim();
            const newComment = commentCell.querySelector('.edit-comment').value.trim();

            try {
                if (newIp !== originalIp) {
                    await updateClientIp(originalIp, newIp);
                }

                if (newComment !== originalComment) {
                    await updateClientComment(newIp, newComment);
                }

                alert('Zaktualizowano klienta.');
                ipCell.textContent = newIp;
                commentCell.textContent = newComment;

                actionCell.innerHTML = `
                    <button class="edit-button">üìù</button>
                    <button class="delete-button">‚ùå</button>`;
                actionCell.querySelector('.edit-button').addEventListener('click', () => toggleEditMode(row));
            } catch (error) {
                alert('Nie uda≈Ço siƒô zaktualizowaƒá klienta.');
                console.error(error);
            }
        });
    }

    async function updateClientIp(oldIp, newIp) {
        const response = await fetch('/clients/editClientIp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ oldIp, newIp }),
        });

        if (!response.ok) {
            alert('Nie uda≈Ço siƒô zaktualizowaƒá adresu IP.');
        }
    }

    async function updateClientComment(ip, comment) {
        const response = await fetch('/clients/editClientComment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ip, comment }),
        });

        if (!response.ok) {
            alert('Nie uda≈Ço siƒô zaktualizowaƒá komentarza.');
        }
    }

    async function addClient(ip, comment) {
        const response = await fetch('/clients/addClient', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ip, comment }),
        });

        if (!response.ok) {
            throw new Error('Failed to add client');
        }
        return response.json();
    }   

    async function addClientToGroup(clientIp, groupName) {
        try {
            await fetch('/clients/addClientToGroup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ client_ip: clientIp, group_name: groupName })
            });
        } catch (error) {
            console.error('Error adding client to group:', error.message);
        }
    }

    async function removeClientFromGroup(clientIp, groupName) {
        try {
            await fetch('/clients/removeClientFromGroup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ client_ip: clientIp, group_name: groupName })
            });
        } catch (error) {
            console.error('Error removing client from group:', error.message);
        }
    }

    async function removeClient(clientIp) {
            const response = await fetch('/clients/removeClient', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ client_ip: clientIp }),
            });

            if (!response.ok) {
                throw new Error('Failed to remove client');
            }
            return response.json();
    };
</script>
</html>
